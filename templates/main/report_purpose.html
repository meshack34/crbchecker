{% load static %}

<!DOCTYPE html>
<html>
<head>
    <title>Select Report Purpose</title>
    <link rel="stylesheet" href="{% static 'css/report_purpose.css' %}">
    <link rel="stylesheet" href="{% static 'css/report_popup.css' %}">
    <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
</head>
<body>
    <div class="purpose-container">
        <h2>Select Report Purpose</h2>

        <form method="post" id="purposeForm">
            {% csrf_token %}
            
            <div class="purpose-grid">
                <label>
                    <input type="radio" name="purpose" value="loan" required>
                    <div class="purpose-card">
                        <i class="fas fa-credit-card"></i> Loan Application
                    </div>
                </label>
                <label>
                    <input type="radio" name="purpose" value="employment">
                    <div class="purpose-card">
                        <i class="fas fa-briefcase"></i> Employment
                    </div>
                </label>
                <label>
                    <input type="radio" name="purpose" value="housing">
                    <div class="purpose-card">
                        <i class="fas fa-home"></i> Housing/Rental
                    </div>
                </label>
                <label>
                    <input type="radio" name="purpose" value="business">
                    <div class="purpose-card">
                        <i class="fas fa-building"></i> Business
                    </div>
                </label>
                <label>
                    <input type="radio" name="purpose" value="personal">
                    <div class="purpose-card">
                        <i class="fas fa-chart-line"></i> Personal Review
                    </div>
                </label>
                <label>
                    <input type="radio" name="purpose" value="legal">
                    <div class="purpose-card">
                        <i class="fas fa-balance-scale"></i> Legal Matters
                    </div>
                </label>
            </div>

            <button type="submit" class="btn-generate">Generate My CRB Report</button>
        </form>
    </div>

    <!-- ðŸ”¹ Loading Modal -->
    <div id="loadingModal" class="modal">
        <div class="loading-box">
            <h3>Generating Your Report</h3>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <span id="progressText">0%</span>
            <p>Please wait while we analyze your credit information and generate your comprehensive report...</p>
        </div>
    </div>

    <!-- ðŸ”¹ Report Modal -->
    <div id="reportModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>

            <div class="report-header">
                <div class="icon-shield"><img src="{% static 'images/logo1.PNG' %}" alt="CRB Logo" class="logo"></div>
                <h2>Hello {{ request.user.first_name }}</h2>
                <p>ID Number: {{ request.user.id_number }}</p>
            </div>

            <div class="report-options">
                <!-- Standard Report -->
                <div class="report-card standard">
                    <h3>Standard Report</h3>
                    <p class="price">KES 187</p>
                    <p class="subtitle">One-time payment</p>
                    <ul>
                        <li>âœ” Credit Score Analysis</li>
                        <li>âœ” Payment History Overview</li>
                        <li>âœ” Credit Utilization Report</li>
                        <li>âœ” Basic Recommendations</li>
                    </ul>
                    <button class="btn-standard">Select Standard â†’</button>
                </div>

                <!-- Gold Premium -->
                <div class="report-card premium">
                    <div class="recommended">RECOMMENDED</div>
                    <h3>Gold Premium</h3>
                    <p class="price">KES 237</p>
                    <p class="subtitle">One-time payment</p>
                    <ul>
                        <li>âœ” All Standard Features</li>
                        <li>âœ” Loan Application Matches</li>
                        <li>âœ” Credit Score Simulator</li>
                        <li>âœ” Personalized Improvement Plan</li>
                        <li>âœ” Monthly Score Updates</li>
                        <li>âœ” Direct Lender Connections</li>
                    </ul>
                    <button class="btn-premium">Select Gold Premium â†’</button>
                </div>
            </div>

            <p class="footer-note">
                By proceeding with the payment, you agree to our terms and conditions. 
                Your credit report will be generated instantly after payment confirmation.
            </p>
        </div>
    </div>

   <!-- ðŸ”¹ Standard Payment Modal -->
<div id="standardPaymentModal" class="modal">
  <div class="modal-content pay-modal standard-theme">
    <span class="close">&times;</span>
    <h2>Pay KES 187.00</h2>
    <p>Follow steps below</p>

    <ol class="steps">
      <li><span>1</span> Go to M-PESA</li>
      <li><span>2</span> Select "Lipa na M-PESA" > "Buy Goods"</li>
      <li><span>3</span> Enter Till <strong>4158516</strong> <button class="copy-btn" onclick="copyTill()">ðŸ“‹</button></li>
      <li><span>4</span> Enter Amount: KES 187.00</li>
      <li><span>5</span> Enter PIN & Confirm</li>
    </ol>

    <label><strong>Paste M-PESA Message</strong></label>
    <textarea id="mpesaMsgStandard" placeholder="Paste your M-PESA message here..."></textarea>

    <button class="btn-validate" onclick="validateMpesa('187.00','mpesaMsgStandard')">Validate Payment</button>
  </div>
</div>

<!-- ðŸ”¹ Premium Payment Modal -->
<div id="premiumPaymentModal" class="modal">
  <div class="modal-content pay-modal premium-theme">
    <span class="close">&times;</span>
    <h2>Pay KES 237.00 <small>(Premium)</small></h2>
    <p>Follow steps below</p>

    <ol class="steps">
      <li><span>1</span> Go to M-PESA</li>
      <li><span>2</span> Select "Lipa na M-PESA" > "Buy Goods"</li>
      <li><span>3</span> Enter Till <strong>4158516</strong> <button class="copy-btn" onclick="copyTill()">ðŸ“‹</button></li>
      <li><span>4</span> Enter Amount: KES 237.00</li>
      <li><span>5</span> Enter PIN & Confirm</li>
    </ol>

    <label><strong>Paste M-PESA Message</strong></label>
    <textarea id="mpesaMsgPremium" placeholder="Paste your M-PESA message here..."></textarea>

    <button class="btn-validate premium-btn" onclick="validateMpesa('237.00','mpesaMsgPremium')">Validate Payment</button>
  </div>
</div>

<!-- ðŸ”¹ Toast -->
<div id="toast"></div>

<script>
const form = document.getElementById("purposeForm");
const loadingModal = document.getElementById("loadingModal");
const reportModal = document.getElementById("reportModal");
const standardModal = document.getElementById("standardPaymentModal");
const premiumModal = document.getElementById("premiumPaymentModal");
const closeBtns = document.querySelectorAll(".close");
const progressFill = document.getElementById("progressFill");
const progressText = document.getElementById("progressText");

// Show loading then report modal
form.addEventListener("submit", function(e) {
    const selected = document.querySelector('input[name="purpose"]:checked');
    if (selected) {
        e.preventDefault(); 
        loadingModal.style.display = "flex"; // show loading modal

        let progress = 0;
        const interval = setInterval(() => {
            progress += 5;
            progressFill.style.width = progress + "%";
            progressText.textContent = progress + "%";
            if (progress >= 100) {
                clearInterval(interval);
                loadingModal.style.display = "none";
                reportModal.style.display = "block";
            }
        }, 150);
    }
});

// Open Standard / Premium Modals
document.querySelector(".btn-standard").addEventListener("click", function() {
    reportModal.style.display = "none";
    standardModal.style.display = "block";
});
document.querySelector(".btn-premium").addEventListener("click", function() {
    reportModal.style.display = "none";
    premiumModal.style.display = "block";
});

// Close all modals
closeBtns.forEach(btn => {
    btn.onclick = () => {
        reportModal.style.display = "none";
        standardModal.style.display = "none";
        premiumModal.style.display = "none";
        loadingModal.style.display = "none";
    };
});
window.onclick = function(event) {
    if (event.target == reportModal) reportModal.style.display = "none";
    if (event.target == standardModal) standardModal.style.display = "none";
    if (event.target == premiumModal) premiumModal.style.display = "none";
    if (event.target == loadingModal) loadingModal.style.display = "none";
}

// Copy Till Number
function copyTill() {
    const till = "4158516";
    navigator.clipboard.writeText(till);
    showToast("Till number copied!", "success");
}

// Validate Mpesa Message
function validateMpesa(amount, textareaId) {
    const msg = document.getElementById(textareaId).value.trim();
    const till = "4158516";
    const regex = new RegExp(`.*KES\\s${amount}.*${till}.*`, "i");

    if (regex.test(msg)) {
        showToast("âœ… Payment Verified Successfully!", "success");
    } else {
        showToast("âŒ Invalid M-PESA message.", "error");
    }
}

// Toast
function showToast(msg, type="info") {
    const toast = document.getElementById("toast");
    toast.textContent = msg;
    toast.className = "show " + type;
    setTimeout(() => { toast.className = toast.className.replace("show", ""); }, 3000);
}
</script>

<style>
/* Toast */
#toast {
  visibility: hidden;
  min-width: 280px;
  margin-left: -140px;
  background-color: #333;
  color: #fff;
  text-align: center;
  border-radius: 8px;
  padding: 12px;
  position: fixed;
  z-index: 10000;
  right: 20px;
  top: 20px;
  font-size: 14px;
  opacity: 0;
  transition: opacity 0.5s, top 0.5s;
}
#toast.show { visibility: visible; opacity: 1; top: 40px; }
#toast.success { background-color: #16a34a; }
#toast.error { background-color: #dc2626; }

/* Standard Theme */
.standard-theme { border-top: 5px solid #3b82f6; }
.standard-theme h2 { color: #3b82f6; }
.btn-validate { background: #3b82f6; color: white; }

/* Premium Theme */
.premium-theme { border-top: 5px solid #facc15; background: #fffbea; }
.premium-theme h2 { color: #ca8a04; }
.premium-btn { background: #facc15; color: black; }

/* Loading Modal */
.loading-box {
  background: white;
  padding: 25px;
  border-radius: 10px;
  width: 380px;
  margin: auto;
  text-align: center;
}
.progress-bar {
  width: 100%;
  background: #e5e7eb;
  border-radius: 5px;
  height: 8px;
  margin: 15px 0;
  overflow: hidden;
}
.progress-fill {
  background: #3b82f6;
  height: 100%;
  width: 0%;
  transition: width 0.2s;
}
#progressText {
  font-size: 14px;
  color: #333;
}
.modal {
  display: none;   /* hidden on page load */
  position: fixed;
  z-index: 9999;
  left: 0; top: 0;
  width: 100%; height: 100%;
  background: rgba(0,0,0,0.6);
  justify-content: center;
  align-items: center;
}
</style>

</body>
</html>
