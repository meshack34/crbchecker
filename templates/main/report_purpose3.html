{% load static %}

<!DOCTYPE html>
<html>
<head>
    <title>Select Report Purpose</title>
    <link rel="stylesheet" href="{% static 'css/report_purpose.css' %}">
    <link rel="stylesheet" href="{% static 'css/report_popup.css' %}">
    <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
</head>
<body>
    <div class="purpose-container">
        <h2>Select Report Purpose</h2>

        <form method="post" id="purposeForm">
            {% csrf_token %}
            
            <div class="purpose-grid">
                <label>
                    <input type="radio" name="purpose" value="loan" required>
                    <div class="purpose-card">
                        <i class="fas fa-credit-card"></i> Loan Application
                    </div>
                </label>
                <label>
                    <input type="radio" name="purpose" value="employment">
                    <div class="purpose-card">
                        <i class="fas fa-briefcase"></i> Employment
                    </div>
                </label>
                <label>
                    <input type="radio" name="purpose" value="housing">
                    <div class="purpose-card">
                        <i class="fas fa-home"></i> Housing/Rental
                    </div>
                </label>
                <label>
                    <input type="radio" name="purpose" value="business">
                    <div class="purpose-card">
                        <i class="fas fa-building"></i> Business
                    </div>
                </label>
                <label>
                    <input type="radio" name="purpose" value="personal">
                    <div class="purpose-card">
                        <i class="fas fa-chart-line"></i> Personal Review
                    </div>
                </label>
                <label>
                    <input type="radio" name="purpose" value="legal">
                    <div class="purpose-card">
                        <i class="fas fa-balance-scale"></i> Legal Matters
                    </div>
                </label>
            </div>

            <button type="submit" class="btn-generate">Generate My CRB Report</button>
        </form>
    </div>

    <!-- üîπ Popup Modal -->
    <div id="reportModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>

            <div class="report-header">
                <div class="icon-shield">üõ°Ô∏è</div>
                <h2>Hello {{ request.user.first_name }}</h2>
                <p>ID Number: {{ request.user.id_number }}</p>
            </div>

            <div class="report-options">
                <!-- Standard Report -->
                <div class="report-card standard">
                    <h3>Standard Report</h3>
                    <p class="price">KES 187</p>
                    <p class="subtitle">One-time payment</p>
                    <ul>
                        <li>‚úî Credit Score Analysis</li>
                        <li>‚úî Payment History Overview</li>
                        <li>‚úî Credit Utilization Report</li>
                        <li>‚úî Basic Recommendations</li>
                    </ul>
                    <button class="btn-standard">Select Standard ‚Üí</button>
                </div>

                <!-- Gold Premium -->
                <div class="report-card premium">
                    <div class="recommended">RECOMMENDED</div>
                    <h3>Gold Premium</h3>
                    <p class="price">KES 237</p>
                    <p class="subtitle">One-time payment</p>
                    <ul>
                        <li>‚úî All Standard Features</li>
                        <li>‚úî Loan Application Matches</li>
                        <li>‚úî Credit Score Simulator</li>
                        <li>‚úî Personalized Improvement Plan</li>
                        <li>‚úî Monthly Score Updates</li>
                        <li>‚úî Direct Lender Connections</li>
                    </ul>
                    <button class="btn-premium">Select Gold Premium ‚Üí</button>
                </div>
            </div>

            <p class="footer-note">
                By proceeding with the payment, you agree to our terms and conditions. 
                Your credit report will be generated instantly after payment confirmation.
            </p>
        </div>
    </div>

   <!-- Payment Modal -->
<div id="paymentModal" class="modal">
  <div class="modal-content pay-modal">
    <span class="close">&times;</span>

    <h2>Pay KES <span id="payAmount">187.00</span></h2>
    <p>Follow steps below</p>

    <ol class="steps">
      <li><span>1</span> Go to M-PESA</li>
      <li><span>2</span> Select "Lipa na M-PESA" > "Buy Goods"</li>
      <li><span>3</span> Enter Till <strong id="tillNumber">4158516</strong> 
          <button class="copy-btn" onclick="copyTill()">üìã</button>
      </li>
      <li><span>4</span> Enter Amount: KES <span id="amountText">187.00</span></li>
      <li><span>5</span> Enter PIN & Confirm</li>
    </ol>

    <label for="mpesaMsg"><strong>Paste M-PESA Message</strong></label>
    <textarea id="mpesaMsg" placeholder="Paste your M-PESA message here..."></textarea>

    <button id="validateBtn" class="btn-validate">Validate Payment</button>
  </div>
</div>

<!-- Toast Container -->
<div id="toast"></div>

<script>
const form = document.getElementById("purposeForm");
const reportModal = document.getElementById("reportModal");
const paymentModal = document.getElementById("paymentModal");
const closeBtns = document.querySelectorAll(".close");

// Step 1: Show Report Modal when loan selected
form.addEventListener("submit", function(e) {
    const selected = document.querySelector('input[name="purpose"]:checked');
    if (selected && selected.value === "loan") {
        e.preventDefault(); 
        reportModal.style.display = "block";
    }
});

// Step 2: Open Payment Modal on Standard/Premium click
document.querySelector(".btn-standard").addEventListener("click", function() {
    reportModal.style.display = "none";
    document.getElementById("payAmount").textContent = "187.00";
    document.getElementById("amountText").textContent = "187.00";
    paymentModal.style.display = "block";
});
document.querySelector(".btn-premium").addEventListener("click", function() {
    reportModal.style.display = "none";
    document.getElementById("payAmount").textContent = "237.00";
    document.getElementById("amountText").textContent = "237.00";
    paymentModal.style.display = "block";
});

// Step 3: Close modals
closeBtns.forEach(btn => {
    btn.onclick = () => {
        reportModal.style.display = "none";
        paymentModal.style.display = "none";
    };
});
window.onclick = function(event) {
    if (event.target == reportModal) reportModal.style.display = "none";
    if (event.target == paymentModal) paymentModal.style.display = "none";
}

// Copy Till Number
function copyTill() {
    const till = document.getElementById("tillNumber").textContent;
    navigator.clipboard.writeText(till);
    showToast("Till number copied!", "success");
}

// Toast Notification
function showToast(msg, type="info") {
    const toast = document.getElementById("toast");
    toast.textContent = msg;
    toast.className = "show " + type;
    setTimeout(() => { toast.className = toast.className.replace("show", ""); }, 3000);
}

// Validate M-PESA Message
document.getElementById("validateBtn").addEventListener("click", function() {
    const msg = document.getElementById("mpesaMsg").value.trim();
    const till = "4158516";
    const amount = document.getElementById("payAmount").textContent;

    const regex = new RegExp(`.*KES\\s${amount}.*${till}.*`, "i");

    if (regex.test(msg)) {
        showToast("‚úÖ Payment Verified Successfully!", "success");
        // AJAX/redirect goes here
    } else {
        showToast("‚ùå Invalid M-PESA message. Please input the correct one", "error");
    }
});
</script>

<style>
/* Toast Notification */
#toast {
  visibility: hidden;
  min-width: 280px;
  margin-left: -140px;
  background-color: #333;
  color: #fff;
  text-align: center;
  border-radius: 8px;
  padding: 12px;
  position: fixed;
  z-index: 10000;
  right: 20px;
  top: 20px;
  font-size: 14px;
  opacity: 0;
  transition: opacity 0.5s, top 0.5s;
}
#toast.show {
  visibility: visible;
  opacity: 1;
  top: 40px;
}
#toast.success { background-color: #16a34a; }
#toast.error { background-color: #dc2626; }
</style>

</body>
</html>
